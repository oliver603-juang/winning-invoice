<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç™¼ç¥¨å°çåŠ©æ‰‹ (æœŸé™ç®¡ç†ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (Dark Theme) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        /* 1. Global Dark Theme & Glassmorphism */
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
        }

        /* è‡ªå®šç¾©ç»ç’ƒæ“¬æ…‹é¡åˆ¥ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); /* æ·±è—åŠé€æ˜ */
            backdrop-filter: blur(12px);       /* èƒŒæ™¯æ¨¡ç³Š */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); /* å¾®äº®é‚Šæ¡† */
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* éš±è— Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* SweetAlert2 Dark Theme Overrides */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: #1e293b !important;
            color: #e2e8f0 !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        div:where(.swal2-input), div:where(.swal2-textarea) {
            background: #0f172a !important;
            color: white !important;
            border: 1px solid #475569 !important;
        }
        
        /* Selection Highlight */
        .invoice-card.selected { 
            border: 2px solid #4ECDC4; 
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            background: rgba(78, 205, 196, 0.1);
        }

        .invoice-card.expired {
            opacity: 0.5;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="glass-header p-4 sticky top-0 z-20">
        <div class="flex justify-between items-center max-w-3xl mx-auto w-full">
            <h1 class="text-xl font-bold text-[#4ECDC4] flex items-center gap-2">
                <i class="fas fa-robot"></i> AI ç™¼ç¥¨å°çæ©Ÿ
            </h1>
            <div class="flex gap-2">
                <button onclick="openWinningNumbersModal()" class="text-slate-400 hover:text-[#4ECDC4] transition-colors" title="ä¸­çè™Ÿç¢¼">
                    <i class="fas fa-list-ol fa-lg"></i>
                </button>
                <button onclick="openSettings()" class="text-slate-400 hover:text-[#FFCB77] transition-colors" title="è¨­å®š">
                    <i class="fas fa-cog fa-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow overflow-y-auto p-4 pb-32 max-w-3xl mx-auto w-full no-scrollbar space-y-4" id="main-container">
        
        <!-- Status Card -->
        <div class="glass-panel rounded-2xl p-4 shadow-xl relative overflow-hidden flex justify-between items-center">
             <div>
                <h2 class="font-bold text-slate-200">
                    <i class="fas fa-calendar-check text-[#FFCB77] mr-1"></i> ç›®å‰å°çæœŸåˆ¥
                </h2>
                <p class="text-xs text-slate-400 mt-1">
                    ç³»çµ±å·²è¼‰å…¥ <span class="text-[#4ECDC4] font-bold" id="active-periods-count">2</span> å€‹æœˆä»½çš„ä¸­çè™Ÿç¢¼
                </p>
             </div>
             <div class="text-right">
                <div class="text-[10px] text-slate-500">ä»Šæ—¥æ—¥æœŸ</div>
                <div class="font-mono font-bold text-slate-200" id="current-date-display"></div>
             </div>
        </div>

        <!-- Toolbar -->
        <div class="flex justify-between items-center px-1">
            <h2 class="text-lg font-bold text-slate-200">æ”¶ç´å¤¾ (<span id="invoice-count" class="text-[#4ECDC4]">0</span>)</h2>
            <div class="flex gap-2">
                <button onclick="toggleSelectAll()" class="text-xs bg-slate-800 text-slate-400 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">
                    å…¨é¸
                </button>
                <button onclick="checkPrizes()" class="text-xs bg-gradient-to-r from-[#4ECDC4] to-[#2cb5ac] text-slate-900 font-bold px-4 py-1.5 rounded-full shadow-lg hover:shadow-[#4ECDC4]/30 transition transform hover:scale-105">
                    <i class="fas fa-search-dollar mr-1"></i> ä¸€éµå°ç
                </button>
            </div>
        </div>

        <!-- Invoice Grid -->
        <div id="invoice-grid" class="grid grid-cols-2 gap-4 pb-4">
            <!-- Content will be injected by JS -->
        </div>

    </main>

    <!-- Floating Action Button (Open Add Modal) -->
    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-30 pointer-events-none">
        <button onclick="openAddModal()" class="pointer-events-auto bg-[#FFCB77] text-slate-900 w-16 h-16 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(255,203,119,0.4)] cursor-pointer hover:bg-[#ffbf57] transition transform hover:scale-110 active:scale-95">
            <i class="fas fa-plus fa-xl"></i>
        </button>
    </div>

    <!-- ADD INVOICE MODAL -->
    <div id="add-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-sm flex flex-col max-h-[85vh] transform scale-95 transition-transform duration-300" id="add-modal-content">
            
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-200">
                    <i class="fas fa-magic text-[#4ECDC4] mr-2"></i>AI æ™ºæ…§åŒ¯å…¥
                </h3>
                <button onclick="closeAddModal()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- Camera Button: Removed 'multiple' to force direct camera launch on mobile -->
                <label class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl p-4 flex flex-col items-center cursor-pointer transition group">
                    <i class="fas fa-camera text-2xl mb-2 text-[#FFCB77] group-hover:scale-110 transition"></i>
                    <span class="text-xs text-slate-400">æ‹ç…§ (å–®å¼µ)</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handleAIUpload(this)">
                </label>
                <!-- Gallery Button: Kept 'multiple' for selecting many files -->
                <label class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl p-4 flex flex-col items-center cursor-pointer transition group">
                    <i class="fas fa-images text-2xl mb-2 text-[#4ECDC4] group-hover:scale-110 transition"></i>
                    <span class="text-xs text-slate-400">ç›¸ç°¿ (å¤šå¼µ)</span>
                    <input type="file" accept="image/*" multiple class="hidden" onchange="handleAIUpload(this)">
                </label>
            </div>

            <div class="text-[10px] text-center mb-2 px-3 py-1 bg-slate-800/50 rounded-full mx-auto cursor-pointer hover:bg-slate-700 transition" id="api-status-pill" onclick="openSettings()">
                <span>æª¢æŸ¥ API Key ä¸­...</span>
            </div>

            <div class="flex-1 overflow-y-auto min-h-[150px] space-y-2 mb-4 pr-1" id="pending-list">
                <div class="text-center text-slate-500 text-xs py-8">
                    é¸æ“‡ç…§ç‰‡å¾Œï¼ŒAI å°‡è‡ªå‹•è¾¨è­˜ï¼š<br>1. ç™¼ç¥¨è™Ÿç¢¼<br>2. ç™¼ç¥¨æœˆä»½ (åˆ¤æ–·æ˜¯å¦éæœŸ)
                </div>
            </div>

            <div class="flex gap-2 shrink-0">
                <button onclick="closeAddModal()" class="flex-1 py-3 text-slate-400 hover:text-white text-sm">å–æ¶ˆ</button>
                <button onclick="savePendingInvoices()" id="btn-save-pending" class="flex-1 bg-[#4ECDC4] text-slate-900 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    åŠ å…¥æ”¶ç´å¤¾
                </button>
            </div>
        </div>
    </div>

    <!-- WINNING NUMBERS MODAL -->
    <div id="winning-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-200">ä¸­çè™Ÿç¢¼è¨­å®š</h3>
                <button onclick="closeWinningNumbersModal()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-slate-800/50 p-3 rounded-lg text-xs text-slate-400 mb-4">
                <i class="fas fa-info-circle mr-1"></i> å› ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•è‡ªå‹•å¾å¤–éƒ¨ç¶²ç«™æŠ“å–ã€‚è«‹æ‰‹å‹•æ›´æ–°æˆ–ç¢ºèªä¸‹æ–¹é è¨­è³‡æ–™ã€‚
            </div>

            <div class="flex-1 overflow-y-auto space-y-4 pr-2" id="winning-numbers-container">
                <!-- Numbers injected here -->
            </div>

            <div class="mt-4 pt-4 border-t border-slate-700 flex gap-2">
                 <button onclick="resetDefaultWinningNumbers()" class="text-xs text-[#4ECDC4] hover:underline px-2">é‚„åŸé è¨­å€¼</button>
                 <div class="flex-1"></div>
                 <button onclick="closeWinningNumbersModal()" class="bg-[#4ECDC4] text-slate-900 px-4 py-2 rounded-lg font-bold text-sm">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- EMAIL MODAL -->
    <div id="email-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-slate-200 flex items-center gap-2">
                <i class="fas fa-envelope text-[#FFCB77]"></i> å¯„é€ä¸­çå ±è¡¨
            </h3>
            <p class="text-xs text-slate-400 mb-4">å°‡ä¸­çç™¼ç¥¨è£½ä½œæˆè¡¨æ ¼ï¼Œå¯„é€åˆ°æ‚¨çš„ä¿¡ç®±ã€‚</p>
            <input type="email" id="emailjs-input" placeholder="your@email.com" class="w-full bg-slate-800 p-3 rounded-xl mb-6 text-sm text-white border border-slate-600 outline-none focus:border-[#4ECDC4]">
            <div class="flex gap-2">
                <button onclick="closeEmailModal()" class="flex-1 py-2 text-slate-400 hover:text-white transition-colors">å–æ¶ˆ</button>
                <button id="btn-send-emailjs" onclick="handleSendEmailJS()" class="flex-1 bg-[#4ECDC4] text-slate-900 rounded-xl font-bold py-2 shadow-lg hover:bg-[#3dbdb4] transition-all flex items-center justify-center gap-2">
                    <span id="btn-text-emailjs">ç¢ºèªç™¼é€</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. State & Data ---
        let invoices = []; 
        let settings = {
            email: "oliver603@gmail.com",
            googleApiKey: "" 
        };
        let pendingReceipts = []; 
        let currentWinnersToSend = [];

        // Database of Winning Numbers
        let winningNumbersDB = {
            "114-09": { 
                periodName: "114å¹´ 09-10æœˆ",
                special: "25834483", 
                grand: "46587380",
                first: ["41016094", "98081574", "07309261"],
                sixth: [] 
            },
            "114-07": { 
                periodName: "114å¹´ 07-08æœˆ",
                special: "53960536", 
                grand: "51509866",
                first: ["43074088", "22870220", "38253117"],
                sixth: [] 
            }
        };

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            
            // Set current date display
            const today = new Date();
            document.getElementById('current-date-display').innerText = `${today.getFullYear()}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getDate().toString().padStart(2,'0')}`;

            if (!settings.googleApiKey) {
                Swal.fire({
                    title: 'æ­¡è¿ä½¿ç”¨',
                    text: 'è«‹å…ˆè¨­å®š Google Gemini API Key ä»¥å•Ÿç”¨ AI è¾¨è­˜åŠŸèƒ½',
                    icon: 'info',
                    confirmButtonText: 'å»è¨­å®š',
                    background: '#1e293b', color: '#fff'
                }).then(() => openSettings());
            }

            // Cleanup expired on load
            cleanupExpiredInvoices();
            
            renderGallery();
            updateApiStatusUI();
            updateActivePeriodsCount();
            
            if (window.emailjs) window.emailjs.init("mYOFMMnqLdDxR0wjj");
        });

        function loadFromStorage() {
            const savedInvoices = localStorage.getItem('invoice_app_data');
            const savedSettings = localStorage.getItem('invoice_app_settings');
            const savedWinning = localStorage.getItem('invoice_winning_db');
            
            if (savedInvoices) invoices = JSON.parse(savedInvoices);
            if (savedSettings) settings = JSON.parse(savedSettings);
            if (savedWinning) winningNumbersDB = JSON.parse(savedWinning);
        }

        function saveToStorage() {
            localStorage.setItem('invoice_app_data', JSON.stringify(invoices));
            localStorage.setItem('invoice_app_settings', JSON.stringify(settings));
            localStorage.setItem('invoice_winning_db', JSON.stringify(winningNumbersDB));
            updateApiStatusUI();
            updateActivePeriodsCount();
        }

        // --- 3. Expiration Logic ---
        function checkExpirationStatus(invoiceYearMonth) {
            if (!invoiceYearMonth) return { expired: false, deadlineStr: "æœªçŸ¥" };

            let year, month;
            let nums = invoiceYearMonth.replace(/\D/g, '-').split('-').filter(n => n);
            
            if (nums.length >= 2) {
                let y = parseInt(nums[0]);
                let m = parseInt(nums[1]);
                if (y < 1911) year = y + 1911;
                else year = y;
                month = m;
            } else {
                return { expired: false, deadlineStr: "æ ¼å¼éŒ¯èª¤" };
            }

            let periodEndMonth = Math.ceil(month / 2) * 2; 
            let redemptionEndYear = year;
            let redemptionEndMonth = 0;
            let redemptionEndDay = 5;

            switch(periodEndMonth) {
                case 2: redemptionEndMonth = 7; break;
                case 4: redemptionEndMonth = 9; break;
                case 6: redemptionEndMonth = 11; break;
                case 8: 
                    redemptionEndMonth = 1; 
                    redemptionEndYear++; 
                    break;
                case 10: 
                    redemptionEndMonth = 3; 
                    redemptionEndYear++; 
                    break;
                case 12: 
                    redemptionEndMonth = 5; 
                    redemptionEndYear++; 
                    break;
            }

            const deadline = new Date(redemptionEndYear, redemptionEndMonth - 1, redemptionEndDay, 23, 59, 59);
            const now = new Date();
            
            return {
                expired: now > deadline,
                deadline: deadline,
                deadlineStr: `${redemptionEndYear}/${redemptionEndMonth}/${redemptionEndDay}`
            };
        }

        function cleanupExpiredInvoices() {
            const initialLen = invoices.length;
            let expiredCount = 0;
            
            invoices = invoices.filter(inv => {
                if (!inv.date) return true; 
                const status = checkExpirationStatus(inv.date);
                if (status.expired) {
                    expiredCount++;
                    return false; 
                }
                return true;
            });

            if (expiredCount > 0) {
                saveToStorage();
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 4000,
                    background: '#1e293b', color: '#fff'
                });
                Toast.fire({ icon: 'warning', title: `å·²è‡ªå‹•ç§»é™¤ ${expiredCount} å¼µéæœŸç™¼ç¥¨` });
            }
        }

        // --- 4. UI Rendering (Fixed Empty State Crash) ---
        function renderGallery() {
            const grid = document.getElementById('invoice-grid');
            document.getElementById('invoice-count').innerText = invoices.length;

            if (invoices.length === 0) {
                // FIXED: Use innerHTML string for empty state to prevent appendChild errors
                grid.innerHTML = `
                    <div class="col-span-2 text-center text-slate-600 py-12 flex flex-col items-center" id="empty-state">
                        <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4">
                            <i class="fas fa-camera fa-2x"></i>
                        </div>
                        <p>æ”¶ç´å¤¾æ˜¯ç©ºçš„</p>
                        <p class="text-xs mt-2 opacity-50">é»æ“Šä¸‹æ–¹ç›¸æ©ŸæŒ‰éˆ•é–‹å§‹</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = invoices.map(inv => {
                const expStatus = checkExpirationStatus(inv.date);
                const deadlineText = expStatus.deadlineStr !== "æœªçŸ¥" ? `é ˜çè‡³: ${expStatus.deadlineStr}` : "";
                
                return `
                <div class="invoice-card relative glass-panel rounded-xl overflow-hidden group transition-all duration-300 ${inv.selected ? 'selected' : 'border-slate-700'}" 
                     onclick="toggleSelect('${inv.id}')">
                    <div class="absolute top-2 right-2 z-10 bg-slate-900/80 rounded-full p-1 shadow backdrop-blur-sm">
                        <i class="fas ${inv.selected ? 'fa-check-circle text-[#4ECDC4]' : 'fa-circle text-slate-600'} fa-lg transition-colors"></i>
                    </div>
                    ${getStatusBadge(inv)}
                    <div class="h-28 bg-slate-800 overflow-hidden relative">
                        <img src="${inv.image}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" loading="lazy">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-slate-900 to-transparent h-10"></div>
                    </div>
                    <div class="p-3">
                        <div class="w-full mb-2">
                             <label class="text-[10px] text-slate-500 block">è™Ÿç¢¼ (8ç¢¼)</label>
                             <input type="text" value="${inv.number || ''}" 
                                 class="w-full bg-transparent border-b border-slate-600 text-slate-200 font-mono font-bold focus:border-[#4ECDC4] outline-none text-lg tracking-widest"
                                 placeholder="AIè¾¨è­˜ä¸­"
                                 onclick="event.stopPropagation()"
                                 onchange="updateInvoiceNumber('${inv.id}', this.value)">
                        </div>
                        <div class="w-full flex justify-between items-center text-xs text-slate-400">
                             <div>
                                <i class="far fa-calendar-alt mr-1"></i>${inv.date || 'æœªçŸ¥æœˆä»½'}
                             </div>
                             <div class="text-[10px] text-slate-600">${deadlineText}</div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function getStatusBadge(inv) {
            if (inv.status === 'win') return `<div class="absolute top-2 left-2 bg-red-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-lg backdrop-blur-sm animate-pulse">ä¸­ç $${inv.amount}</div>`;
            if (inv.status === 'loss') return `<div class="absolute top-2 left-2 bg-slate-600/90 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow backdrop-blur-sm">æœªä¸­ç</div>`;
            return `<div class="absolute top-2 left-2 bg-[#FFCB77] text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded shadow-lg">æœªå°ç</div>`;
        }

        // --- 5. AI Processing (Robust Gemini with Fallback) ---
        function openAddModal() {
            const modal = document.getElementById('add-modal');
            const content = document.getElementById('add-modal-content');
            modal.classList.remove('hidden');
            updateApiStatusUI();
            
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
            
            pendingReceipts = [];
            renderPendingList();
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal');
            const content = document.getElementById('add-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function handleAIUpload(input) {
            if (!input.files || input.files.length === 0) return;
            if (!settings.googleApiKey) {
                Swal.fire({icon: 'warning', title: 'ç¼ºå°‘ API Key', text: 'è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Google Gemini API Key', background: '#1e293b', color: '#fff'});
                return;
            }

            const files = Array.from(input.files);
            
            const newItems = files.map(file => ({
                id: Math.random().toString(36).substr(2, 9),
                file,
                status: 'analyzing', 
                data: {},
                preview: URL.createObjectURL(file) 
            }));
            
            pendingReceipts = [...pendingReceipts, ...newItems];
            renderPendingList();

            await Promise.all(newItems.map(async (item) => {
                try {
                    const base64 = await fileToBase64(item.file);
                    const result = await callGeminiAPI(base64);
                    
                    const exp = checkExpirationStatus(result.date);
                    if (exp.expired) {
                        item.status = 'error';
                        item.error = 'å·²éæœŸ (' + exp.deadlineStr + ' æ­¢)';
                    } else {
                        item.status = 'success';
                        item.data = result;
                        item.base64 = base64; 
                    }
                } catch (error) {
                    console.error("Gemini API Error Details:", error);
                    item.status = 'error';
                    const msg = error.message.toLowerCase();
                    if (msg.includes('key')) item.error = 'API Key ç„¡æ•ˆ';
                    else if (msg.includes('quota') || msg.includes('429')) item.error = 'é¡åº¦ä¸è¶³';
                    else if (msg.includes('found')) item.error = 'æ¨¡å‹ç‰ˆæœ¬éŒ¯èª¤ (è«‹æ›´æ–°)';
                    else if (msg.includes('argument') || msg.includes('400')) item.error = 'åœ–ç‰‡ç„¡æ³•è™•ç†';
                    else item.error = 'è¾¨è­˜å¤±æ•—: ' + error.message;
                }
                renderPendingList();
            }));
            input.value = ''; 
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // UPDATED: Robust API Call with Fallback Models
        async function callGeminiAPI(base64String) {
            const apiKey = settings.googleApiKey;
            
            // List of models to try in order.
            const candidateModels = [
                "gemini-2.5-flash-preview-09-2025",
                "gemini-1.5-flash",
                "gemini-1.5-pro"
            ];
            
            let lastError = null;

            const prompt = `
                Analyze this image of a Taiwan Uniform Invoice (çµ±ä¸€ç™¼ç¥¨).
                Please extract strictly ONLY these two fields and return a valid JSON object:
                1. "number": The 8-digit invoice number (e.g., "12345678"). Ignore the 2-letter prefix.
                2. "date": The Year-Month period found on the invoice (e.g., "114-09", "114å¹´09-10æœˆ", or "2025-09"). Format it as "YYY-MM" (ROC year) or "YYYY-MM" (AD year).
                
                If the number is unclear, leave it empty.
                Do NOT extract amount or store name.
                JSON format: {"number": "...", "date": "..."}
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64String.split(',')[1] } }
                    ]
                }]
            };

            // Loop through models until one works
            for (const model of candidateModels) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                try {
                    console.log(`Trying model: ${model}...`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const message = errorData.error?.message || response.statusText;
                        
                        // If 404 Not Found (Model not supported), try next.
                        // Other errors (403 Key, 429 Quota) should throw immediately.
                        if (response.status === 404) {
                            console.warn(`Model ${model} not found, trying next...`);
                            lastError = new Error(`Model ${model} not found`);
                            continue; // Try next model
                        } else {
                            throw new Error(message); // Fatal error for this key/request
                        }
                    }

                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0]) {
                        throw new Error("No response candidates");
                    }
                    
                    const text = data.candidates[0].content.parts[0].text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    
                    if (jsonMatch) return JSON.parse(jsonMatch[0]);
                    return { number: "", date: "" }; // Fallback empty

                } catch (e) {
                    lastError = e;
                    if (!e.message.includes("not found")) {
                        throw e; // Fatal error
                    }
                }
            }
            
            throw lastError || new Error("All models failed");
        }

        function renderPendingList() {
            const container = document.getElementById('pending-list');
            if (pendingReceipts.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 text-xs py-8">é¸æ“‡ç…§ç‰‡å¾Œï¼ŒAI å°‡è‡ªå‹•è¾¨è­˜</div>`;
                return;
            }

            container.innerHTML = pendingReceipts.map(item => `
                <div class="flex items-center gap-3 p-2 rounded-xl bg-slate-800/50 border border-slate-700">
                    <img src="${item.preview}" class="w-12 h-12 rounded object-cover bg-slate-700">
                    
                    <div class="flex-1 min-w-0">
                        ${item.status === 'analyzing' ? `
                            <div class="flex items-center gap-2 text-xs text-[#4ECDC4]">
                                <i class="fas fa-spinner fa-spin"></i> AI è­˜åˆ¥ä¸­...
                            </div>
                        ` : item.status === 'error' ? `
                            <div class="text-xs text-red-400">
                                <i class="fas fa-trash-alt mr-1"></i> ${item.error}
                            </div>
                        ` : `
                            <div class="flex items-center gap-2">
                                <span class="font-mono font-bold text-lg text-white tracking-widest">${item.data.number || 'ç„¡è™Ÿç¢¼'}</span>
                                <i class="fas fa-check-circle text-green-500 text-xs"></i>
                            </div>
                            <div class="text-[10px] text-slate-400">
                                ${item.data.date || 'æœªçŸ¥æœˆä»½'}
                            </div>
                        `}
                    </div>

                    <button onclick="removePending('${item.id}')" class="text-slate-500 hover:text-red-400 px-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            const validCount = pendingReceipts.filter(p => p.status === 'success' && p.data.number).length;
            document.getElementById('btn-save-pending').innerHTML = validCount > 0 ? `å„²å­˜ ${validCount} å¼µç™¼ç¥¨` : `åŠ å…¥æ”¶ç´å¤¾`;
        }

        function removePending(id) {
            pendingReceipts = pendingReceipts.filter(p => p.id !== id);
            renderPendingList();
        }

        async function savePendingInvoices() {
            const validItems = pendingReceipts.filter(p => p.status === 'success');
            if (validItems.length === 0) {
                closeAddModal();
                return;
            }

            Swal.showLoading();

            for (const item of validItems) {
                const resizedBase64 = await resizeBase64(item.base64, 800);
                invoices.unshift({
                    id: Date.now() + Math.random().toString(),
                    image: resizedBase64,
                    number: item.data.number || '',
                    date: item.data.date,
                    amount: 0, 
                    status: 'unchecked',
                    selected: true
                });
            }

            saveToStorage();
            renderGallery();
            closeAddModal();
            Swal.close();
        }

        function resizeBase64(base64, maxWidth) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = base64;
            });
        }

        // --- 6. Prize Checking Logic ---
        function checkPrizes() {
            const selectedInvoices = invoices.filter(i => i.selected);
            if (selectedInvoices.length === 0) {
                Swal.fire({icon: 'info', title: 'è«‹å…ˆå‹¾é¸ç™¼ç¥¨', background: '#1e293b', color: '#fff'});
                return;
            }

            let winners = [];
            let losersToDelete = [];
            let skippedCount = 0;
            let skippedPeriods = new Set();

            selectedInvoices.forEach(inv => {
                if (!inv.number || inv.number.length < 8) return;

                const periodKey = getPeriodKeyFromDate(inv.date);
                if (!periodKey || !winningNumbersDB[periodKey]) {
                    skippedCount++;
                    if(periodKey) skippedPeriods.add(periodKey);
                    return;
                }

                const rules = winningNumbersDB[periodKey];
                const prize = calculatePrizeAmount(inv.number, rules);
                
                inv.amount = prize;
                if (prize > 0) {
                    inv.status = 'win';
                    winners.push(inv);
                } else {
                    inv.status = 'loss';
                    losersToDelete.push(inv.id);
                }
                inv.selected = false;
            });

            if (losersToDelete.length > 0) {
                invoices = invoices.filter(inv => !losersToDelete.includes(inv.id));
            }
            saveToStorage();
            renderGallery();

            if (winners.length > 0) {
                const totalPrize = winners.reduce((sum, w) => sum + w.amount, 0);
                Swal.fire({
                    title: 'ğŸ‰ æ­å–œä¸­çï¼',
                    html: `ç™¼ç¾ <b>${winners.length}</b> å¼µä¸­çç™¼ç¥¨ï¼<br>ç¸½é‡‘é¡: <b class="text-[#4ECDC4] text-2xl">$${totalPrize}</b>`,
                    icon: 'success',
                    background: '#1e293b', color: '#fff',
                    showCancelButton: true,
                    confirmButtonText: 'ç™¼é€ Email',
                    confirmButtonColor: '#4ECDC4'
                }).then((res) => {
                    if (res.isConfirmed) openEmailModal(winners);
                });
            } else if (skippedCount > 0) {
                Swal.fire({
                    title: 'å°šæœªé–‹çæˆ–ç„¡è³‡æ–™',
                    html: `æ‚¨å‹¾é¸çš„ <b>${skippedCount}</b> å¼µç™¼ç¥¨æ‰€å±¬æœŸåˆ¥ (${Array.from(skippedPeriods).join(', ')}) å°šæœªé–‹çï¼Œæˆ–ç³»çµ±æœªè¼‰å…¥è©²æœŸä¸­çè™Ÿç¢¼ã€‚<br><span class="text-xs text-slate-400">è«‹ç¢ºèªã€Œä¸­çè™Ÿç¢¼ã€è¨­å®šï¼Œæˆ–ç­‰å¾…é–‹çæ—¥ (å–®æ•¸æœˆ25æ—¥) å†è©¦ã€‚</span>`,
                    icon: 'warning',
                    background: '#1e293b', color: '#fff',
                    confirmButtonColor: '#4ECDC4'
                });
            } else {
                Swal.fire({
                    title: 'å°çå®Œæˆ',
                    text: losersToDelete.length > 0 ? `å·²æ¸…é™¤ ${losersToDelete.length} å¼µæœªä¸­çç™¼ç¥¨ã€‚` : "æ²’æœ‰ç™¼ç¾ä¸­çç™¼ç¥¨ã€‚",
                    icon: 'info',
                    background: '#1e293b', color: '#fff'
                });
            }
        }

        function getPeriodKeyFromDate(dateStr) {
            if (!dateStr) return null;
            let nums = dateStr.replace(/\D/g, '-').split('-').filter(n=>n);
            if (nums.length < 2) return null;
            let y = parseInt(nums[0]);
            let m = parseInt(nums[1]);
            if (y > 1911) y -= 1911; 
            let periodM = (m % 2 === 0) ? m - 1 : m;
            return `${y}-${periodM.toString().padStart(2,'0')}`;
        }

        function calculatePrizeAmount(userNum, rules) {
            if (!rules) return 0;
            userNum = userNum.toString().trim();
            if (userNum === rules.special) return 10000000;
            if (userNum === rules.grand) return 2000000;
            for (let target of rules.first) {
                if (userNum === target) return 200000;
                if (userNum.slice(1) === target.slice(1)) return 40000;
                if (userNum.slice(2) === target.slice(2)) return 10000;
                if (userNum.slice(3) === target.slice(3)) return 4000;
                if (userNum.slice(4) === target.slice(4)) return 1000;
                if (userNum.slice(5) === target.slice(5)) return 200;
            }
            return 0;
        }

        // --- 7. Winning Numbers UI ---
        function openWinningNumbersModal() {
            renderWinningNumbersList();
            document.getElementById('winning-modal').classList.remove('hidden');
        }

        function closeWinningNumbersModal() {
            document.getElementById('winning-modal').classList.add('hidden');
        }

        function renderWinningNumbersList() {
            const container = document.getElementById('winning-numbers-container');
            const keys = Object.keys(winningNumbersDB).sort().reverse();
            container.innerHTML = keys.map(key => {
                const data = winningNumbersDB[key];
                return `
                <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-[#4ECDC4] font-bold text-sm">${data.periodName || key}</h4>
                        <span class="text-[10px] text-slate-500 font-mono">${key}</span>
                    </div>
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between"><span class="text-slate-400">ç‰¹åˆ¥ç</span> <span class="text-red-400 font-mono">${data.special}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">ç‰¹ç</span> <span class="text-red-400 font-mono">${data.grand}</span></div>
                        <div class="flex justify-between"><span class="text-slate-400">é ­ç</span> <span class="text-red-400 font-mono text-right">${data.first.join('<br>')}</span></div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateActivePeriodsCount() {
            const count = Object.keys(winningNumbersDB).length;
            document.getElementById('active-periods-count').innerText = count;
        }

        function resetDefaultWinningNumbers() {
             Swal.fire({
                title: 'é‡ç½®è³‡æ–™?',
                text: 'é€™å°‡æœƒæ¢å¾©ç‚ºé è¨­çš„ 114å¹´ 9-10æœˆèˆ‡ 7-8æœˆä¸­çè™Ÿç¢¼ã€‚',
                icon: 'warning',
                showCancelButton: true,
                background: '#1e293b', color: '#fff',
                confirmButtonColor: '#4ECDC4'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('invoice_winning_db');
                    location.reload(); 
                }
            });
        }

        // --- 8. Utils & Email ---
        function toggleSelect(id) {
            const idx = invoices.findIndex(i => i.id === id);
            if (idx > -1) {
                invoices[idx].selected = !invoices[idx].selected;
                renderGallery();
            }
        }

        function toggleSelectAll() {
            const allSelected = invoices.every(i => i.selected);
            invoices.forEach(i => i.selected = !allSelected);
            renderGallery();
        }

        function updateInvoiceNumber(id, newVal) {
            const idx = invoices.findIndex(i => i.id === id);
            if (idx > -1) {
                invoices[idx].number = newVal;
                saveToStorage();
            }
        }
        
        function updateApiStatusUI() {
            const pill = document.getElementById('api-status-pill');
            if (settings.googleApiKey) {
                pill.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span> AI æº–å‚™å°±ç·’`;
                pill.className = "text-[10px] text-center mb-2 px-3 py-1 bg-green-500/20 text-green-400 rounded-full mx-auto border border-green-500/30 cursor-pointer";
            } else {
                pill.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span> æœªè¨­å®š API Key (é»æ­¤è¨­å®š)`;
                pill.className = "text-[10px] text-center mb-2 px-3 py-1 bg-red-500/20 text-red-400 rounded-full mx-auto border border-red-500/30 cursor-pointer animate-pulse";
            }
        }

        function openSettings() {
            Swal.fire({
                title: 'âš™ï¸ è¨­å®š',
                html: `
                    <div class="text-left mb-2 text-xs text-slate-400 flex justify-between items-center">
                        <span>Google Gemini API Key</span>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] bg-[#4ECDC4] text-slate-900 px-3 py-1.5 rounded-full font-bold hover:bg-[#3dbdb4] no-underline shadow-lg transform transition hover:scale-105">
                            <i class="fas fa-key mr-1"></i>å–å¾—å…è²» Key
                        </a>
                    </div>
                    <input id="swal-apikey" class="swal2-input mb-4" type="password" value="${settings.googleApiKey || ''}" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ API Key">
                    <div class="text-left mb-2 text-xs text-slate-400">Email</div>
                    <input id="swal-email" class="swal2-input" value="${settings.email}">
                `,
                background: '#1e293b', color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'å„²å­˜',
                confirmButtonColor: '#4ECDC4',
                preConfirm: () => ({
                    googleApiKey: document.getElementById('swal-apikey').value.trim(),
                    email: document.getElementById('swal-email').value
                })
            }).then((result) => {
                if (result.isConfirmed) {
                    settings.googleApiKey = result.value.googleApiKey;
                    settings.email = result.value.email;
                    saveToStorage();
                    Swal.fire({icon: 'success', title: 'å·²å„²å­˜', background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false});
                }
            });
        }

        function openEmailModal(winners) {
            currentWinnersToSend = winners;
            document.getElementById('emailjs-input').value = settings.email;
            document.getElementById('email-modal').classList.remove('hidden');
        }

        function closeEmailModal() {
            document.getElementById('email-modal').classList.add('hidden');
        }

        async function handleSendEmailJS() {
            const emailInput = document.getElementById('emailjs-input').value;
            if(!emailInput) return;
            settings.email = emailInput;
            saveToStorage();
            
            const btn = document.getElementById('btn-send-emailjs');
            btn.innerText = "ç™¼é€ä¸­...";
            
            try {
                let tableRows = currentWinnersToSend.map(item => `
                    <tr>
                        <td style="border:1px solid #ddd;padding:8px">${item.date}</td>
                        <td style="border:1px solid #ddd;padding:8px;font-weight:bold;color:#2c3e50">${item.number}</td>
                        <td style="border:1px solid #ddd;padding:8px;color:#e74c3c;font-weight:bold">$${item.amount}</td>
                    </tr>`).join('');
                
                await window.emailjs.send("service_5yh7x6g", "template_dlbyml8", {
                    email: emailInput,
                    subject: "ã€ç™¼ç¥¨ä¸­çé€šçŸ¥ã€‘",
                    message: `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f8f9fa"><th>æœˆä»½</th><th>è™Ÿç¢¼</th><th>çé‡‘</th></tr></thead><tbody>${tableRows}</tbody></table>`
                });
                
                Swal.fire({icon: 'success', title: 'ç™¼é€æˆåŠŸ', background: '#1e293b', color: '#fff'});
                closeEmailModal();
            } catch(e) {
                console.error(e);
                Swal.fire({icon: 'error', title: 'ç™¼é€å¤±æ•—', background: '#1e293b', color: '#fff'});
            } finally {
                btn.innerText = "ç¢ºèªç™¼é€";
            }
        }
    </script>
</body>
</html>
